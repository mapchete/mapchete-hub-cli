name: Python package test

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
  schedule:
    - cron: '0 8 * * 1,4'
  workflow_call:
    inputs:
      override-deps-artifact:
        description: "Name of artifact containing updated lockfiles"
        required: false
        type: string    

jobs:
  lint:
    name: "ðŸ“ Pre-commit / Code Quality"
    runs-on: ubuntu-latest
    # Skip linting when triggered by the Sync Workflow (it just updated locks)
    if: github.event_name != 'workflow_call'
    steps:
      - uses: actions/checkout@v4
      - name: âš¡ Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: ðŸƒ Run Pre-commit
        run: |
          uv tool install pre-commit
          uv tool run pre-commit run --show-diff-on-failure --all-files

  setup:
      name: "ðŸ—ï¸ Build Py${{ matrix.python-version }}"
      needs: lint
      if: |
        always() && 
        (needs.lint.result == 'success' || needs.lint.result == 'skipped')
      runs-on: ubuntu-latest
      strategy:
        matrix:
          python-version: ["3.11", "3.12", "3.13"]
      steps:
        - uses: actions/checkout@v4

        - name: ðŸ“¥ Apply Dependency Overrides
          if: "${{ inputs.override-deps-artifact != '' }}"
          uses: actions/download-artifact@v4
          with:
            name: ${{ inputs.override-deps-artifact }}

        - name: âš¡ Install uv
          run: |
            apt-get update && apt-get install -y curl
            curl -LsSf https://astral.sh/uv/install.sh | BINDIR=/usr/local/bin sh

        - name: ðŸ“ Export Locked Requirements
          run: |
            uv export --frozen --all-extras --format requirements-txt > requirements.txt
      
        - name: ðŸ“¤ Upload Requirements
          uses: actions/upload-artifact@v4
          with:
            name: frozen-reqs-${{ matrix.python-version }}
            path: requirements.txt
            retention-days: 1

  test:
    needs: setup
    name: "ðŸ§ª py${{ matrix.python-version }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“¥ Download Requirements
        uses: actions/download-artifact@v4
        with:
          name: frozen-reqs-${{ matrix.python-version }}

      - name: ðŸ“¥ Apply Dependency Overrides
        if: "${{ inputs.override-deps-artifact != '' }}"
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.override-deps-artifact }}          
      
      - name: âš¡ Install uv & git
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git gpg

          curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="/usr/local/bin" sh          

          uv --version

      - name: ðŸ—ï¸ Restore Native Env
        run: |
          uv venv --python ${{ matrix.python-version }}
          uv pip install -r requirements.txt
          uv pip install -e ".[test]" --no-deps      
         
      - name: ðŸ§ª Run Split
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REQUEST_PAYER: ${{ vars.AWS_REQUEST_PAYER }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          CURL_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
          COVERAGE_FILE: .coverage.python.${{ matrix.python-version }}
        run: |
            uv run pytest -v \
            --cov=mapchete_hub_cli \
            --cov-report=xml:coverage.xml \
            --junitxml="pytest-${{ matrix.python-version }}.xml"

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: py${{ matrix.python-version }}
          fail_ci_if_error: true

      - name: ðŸ“¤ Upload Coverage Chunk (Latest Only)
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-all
          path: .coverage.python.${{ matrix.python-version }}
          include-hidden-files: true
          retention-days: 1

      - name: ðŸ“¤ Archive JUnit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.python-version }}
          path: pytest-${{ matrix.python-version }}.xml
          retention-days: 1

  summary:
    name: "ðŸ“Š Final Summary & Coverage"
    needs: [test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Needed for coverage to see source files

      - name: âš¡ Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: "*-*" 
          merge-multiple: true

      - name: ðŸ“Š Check Tests & Coverage
        run: |
          echo "### ðŸ§ª Test & Coverage Summary" >> $GITHUB_STEP_SUMMARY
          
          # 1. CHECK OVERALL TEST STATUS
          if [[ "${{ needs.test.result }}" != "success"; then
            echo "âŒ **Test Suite Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Coverage check skipped because tests failed." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… **Test Suite Passed**" >> $GITHUB_STEP_SUMMARY

          # 2. COMBINE COVERAGE (Only 3.13 files exist here)
          uv tool install coverage
          
          # Move the specific 3.13 files to root
          # The pattern matches .coverage.3.13.1, .coverage.3.13.2, etc.
          mv all-results/.coverage* .
          
          echo "Merging coverage files..."
          uv tool run coverage combine
          
          # 3. ENFORCE 70%
          OUTPUT=$(uv tool run coverage report --show-missing --fail-under=70 2>&1)
          EXIT_CODE=$?
          
          echo "$OUTPUT"
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ **Coverage Failed:** Python 3.13 coverage is below 70%." >> $GITHUB_STEP_SUMMARY
            # Exit with the original code to fail the build
            exit $EXIT_CODE
          else
            echo "âœ… **Coverage Passed:** 70% coverage achieved (Py3.13)." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi